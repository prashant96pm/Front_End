"use strict";var app=angular.module("quora",["ui.router","infinite-scroll","hc.marked","ngFileUpload"]);app.constant("tokenStorageKey","my-token"),app.filter("unsafe",function(t){return function(o){return t.trustAsHtml(o)}}).run(function(t,o){t.$on("logout",function(){t.$broadcast("loggedOut")}),t.$on("login",function(){t.$broadcast("loggedIn")}),t.$on("tag posts",function(o,e){t.$broadcast("filteredByTags",e)}),t.$on("getNotifications",function(o,e){t.$broadcast("notifications",e)}),t.$on("notHome",function(){t.$broadcast("removeTagFilter")}),t.$on("inHome",function(){t.$broadcast("addTagFilter")}),t.isNotLoggedIn=function(){swal({title:"Not Logged In!",text:"You must be logged in to complete this action.",showCancelButton:!0,confirmButtonColor:"#B92B27",confirmButtonText:"Go to Login?",closeOnConfirm:!1,imageUrl:"../assets/Tied_Hands-100.png"},function(){swal({title:"Redirecting!",type:"success",timer:750,showConfirmButton:!1}),o.go("users.login")})}}),app.config(["$stateProvider","$locationProvider","$urlRouterProvider","markedProvider",function(t,o,e,s){o.html5Mode(!0).hashPrefix("!"),s.setOptions({gfm:!0,tables:!0,highlight:function(t,o){return o?hljs.highlight(o,t,!0).value:hljs.highlightAuto(t).value}}),t.state("home",{url:"/",templateUrl:"/html/general/home.html",controller:"homeCtrl"}).state("thread",{url:"/thread/:thread?",templateUrl:"/html/general/thread.html",controller:"threadCtrl"}).state("compose",{url:"/compose",templateUrl:"/html/general/compose.html",controller:"composeCtrl"}).state("topic",{url:"/topics/:topic?",templateUrl:"/html/general/topic.html",controller:"topicCtrl"}).state("users",{"abstract":!0,templateUrl:"/html/users/users.html"}).state("users.login",{url:"/login",templateUrl:"/html/users/form.html",controller:"usersCtrl"}).state("users.notifications",{url:"/notifications",templateUrl:"/html/users/notifications.html",controller:"notificationsCtrl"}).state("users.profile",{url:"/profile/:user?",templateUrl:"/html/users/profile.html",controller:"profileCtrl"}),e.otherwise("/")}]),app.controller("composeCtrl",function(t,o,e,s,n,i,r){var c=n.currentUser();$(document).foundation(),t.topics=[],t.selectedTopic,t.toggleDropdown=!1,function(){r.getTopics().success(function(o){t.topics=o}).error(function(t){console.log("error: ",t)});var o={postType:"question"};i.getSortedPosts(o).success(function(o){t.topQuestion=o[0]})}(),t.addTopicToPost=function(o){t.selectedTopic=o.name,t.toggleDropdown=!0,window.setTimeout(function(){t.toggleDropdown=!1},50)},t.submitQuestion=function(t,o,s){if(t){var r={author:c._id,title:o.title,tags:o.tags,content:o.content,topic:s,postType:"question",token:n.getToken()};i.createPost(r).success(function(t){e.path("thread/"+t._id)}).error(function(t){console.log(t)})}else swal({title:"Invalid Form",text:"Incorrect Inputs",timer:2e3,type:"error",confirmButtonColor:"#B92B27"})},t.submitTopic=function(o){console.log("SUBMIT POST FUNCTION STARTS");var e={name:o.name,about:o.about,token:n.getToken()};r.createTopic(e).success(function(o){t.topics.push(o),swal({title:"Success!",text:"You've made a new Topic!",timer:750,showConfirmButton:!1}),s.go("compose")}).error(function(t){swal({title:"Error!",text:"Missing fields!",showConfirmButton:!0})})},t.$emit("notHome"),t.$emit("getNotifications")}),app.controller("homeCtrl",function(t,o,e,s,n,i,r,c,u){t.topicFeed;var l=i.currentUser();t.loggedIn=i.isLoggedIn(),$(document).foundation(),t.loggedIn||o.go("users.login"),t.getPosts=function(o){t.posts=[],t.topicFeed=[];var i={postType:"question",sortingMethod:o};e.getSortedPosts(i).success(function(o){t.posts=o}),n.get7Topics().success(function(o){t.topicFeed=o}),s.getUser(l._id).success(function(o){t.subscriptions=o.subscriptions})},t.getPosts("likes"),t.sortLikes=function(){$(".filter").removeClass("active"),$("#likes").addClass("active"),t.getPosts("likes")},t.sortDislikes=function(){$(".filter").removeClass("active"),$("#dislikes").addClass("active"),t.getPosts("dislikes")},t.sortOldest=function(){$(".filter").removeClass("active"),$("#oldest").addClass("active"),t.getPosts("oldest")},t.sortNewest=function(){$(".filter").removeClass("active"),$("#newest").addClass("active"),t.getPosts("newest")},t.sortSubscriptions=function(){$(".filter").removeClass("active"),$("#subscriptions").addClass("active"),e.subscriptionsPosts(l._id).success(function(o){t.posts=o})},t.togglePostLike=function(o,s){var n=void 0,r=void 0;n="post"===o?t.posts:t.comments,r=n[s].liked?"unlike":"like";var c={pid:n[s]._id,uid:l._id,type:r,token:i.getToken()};e.changeStats(c).success(function(t){"like"===r?(n[s].likes+=1,n[s].liked=!0):(n[s].likes-=1,n[s].liked=!1)})},t.togglePostDislike=function(o,s){var n=void 0,r=void 0;n="post"===o?t.posts:t.comments,r=n[s].disliked?"undo":"dislike";var c={pid:n[s]._id,uid:l._id,type:r,token:i.getToken()};e.changeStats(c).success(function(t){"dislike"===r?(n[s].dislikes+=1,n[s].disliked=!0):(n[s].dislikes-=1,n[s].disliked=!1)})},t.showComments=function(o){t.posts[o].showComments=!0;var s=(t.posts[o].comments,{sortingMethod:"likes",pid:t.posts[o]._id,postType:"comment"});e.getSortedComments(s).success(function(o){t.comments=o})},t.hideComments=function(o){t.posts[o].showComments=!1},t.submitComment=function(o,s){var n={content:o,author:l._id,responseTo:s._id,postType:"comment",token:i.getToken()};e.createPost(n).success(function(o){t.comments.push(o)}).error(function(t){console.log("failed to submit comment"),console.error(t)})},t.deletePost=function(o,s){e.deletePost(o._id).success(function(o){switch(o.postType){case"comment":t.comments.splice(s,1);break;case"question":t.posts.splice(s,1)}}).error(function(t){console.log("failed at deletePost function "),console.error(t)})},t.$emit("getNotifications"),t.$emit("inHome"),t.$on("filteredByTags",function(o,e){t.posts=e}),t.$on("loggedOut",function(){t.loggedIn=i.isLoggedIn(),t.getPosts()}),t.$on("loggedIn",function(){t.loggedIn=i.isLoggedIn()})}),app.controller("notificationsCtrl",function(t,o,e,s,n,i){t.currentUser=e.currentUser(),t.newNotifications,t.oldNotifications,$(document).foundation(),(t.getNotifications=function(){t.newNotifications=[],t.oldNotifications=[];var o={uid:t.currentUser._id};s.getNotifs(o).success(function(e){t.newNotifications=e.notifications.filter(function(t){return!t.seen}),t.oldNotifications=e.notifications.filter(function(t){return t.seen}),s.clearNotifs(o).success(function(t){console.log("user: ",t)}).error(function(t){console.log("error: ",t)})}).error(function(t){console.log("error: ",t)})})(),t.$emit("notHome")}),app.controller("profileCtrl",function(t,o,e,s,n,i,r){$(document).foundation(),t.currentUser=!1,t.followed=!1;var c=n.currentUser();t.posts,i.getUser(e.user).success(function(o){o._id===n.currentUser()._id&&(t.currentUser=!0),-1!==o.followers.indexOf(c._id)?t.followed=!0:t.followed=!1,t.user=o}),t.togglePostLike=function(o,e){var s=void 0,i=void 0;s="post"===o?t.user.posts:t.comments,i=s[e].liked?"unlike":"like";var u={pid:s[e]._id,uid:c._id,type:i,token:n.getToken()};r.changeStats(u).success(function(t){"like"===i?(s[e].likes+=1,s[e].liked=!0):(s[e].likes-=1,s[e].liked=!1)})},t.togglePostDislike=function(o,e){var s=void 0,i=void 0;s="post"===o?t.user.posts:t.comments,i=s[e].disliked?"undo":"dislike";var u={pid:s[e]._id,uid:c._id,type:i,token:n.getToken()};r.changeStats(u).success(function(t){"dislike"===i?(s[e].dislikes+=1,s[e].disliked=!0):(s[e].dislikes-=1,s[e].disliked=!1)})},t.showComments=function(o){t.user.posts[o].showComments=!0;var e=(t.user.posts[o].comments,{sortingMethod:"likes",pid:t.user.posts[o]._id,postType:"comment"});r.getSortedComments(e).success(function(o){t.comments=o})},t.hideComments=function(o){t.user.posts[o].showComments=!1},t.submitComment=function(e,s){var i={content:e,author:c._id,responseTo:s._id,postType:"comment",token:n.getToken()};r.createPost(i).success(function(o){t.comments.push(o)}).error(function(t){o.warning("failed to submit comment"),o.error(t)})},t.deletePost=function(e,s){r.deletePost(e._id).success(function(o){switch(o.postType){case"comment":t.user.comments.splice(s,1);break;case"question":t.user.posts.splice(s,1)}}).error(function(t){o.warning("failed at deletePost function "),o.error(t)})},t.updateInfo=function(o){i.updateInfo(o).then(function(o){t.user=o.data})},t.$emit("getNotifications"),t.$emit("notHome")}),app.controller("threadCtrl",function(t,o,e,s,n,i){t.displayAnswerForm=!1;var r=e.currentUser();t.loggedIn=e.isLoggedIn(),$(document).foundation(),t.answers,t.comments,t.question,(t.getPost=function(){s.getPost(i.thread).success(function(o){t.question=o,t.topic=o.topic,t.comments=o.comments;var e={sortingMethod:"likes",pid:o._id};s.getSortedAnswers(e).success(function(o){t.answers=o})}).error(function(t){console.log(t)})})(),t.submitAnswer=function(o,n){var i={content:o,author:r._id,responseTo:n._id,postType:"answer",token:e.getToken()};s.createPost(i).success(function(o){t.answers.push(o),console.log(o)}).error(function(t){console.log("error: ",t)})},t.togglePostLike=function(o,n){var i=void 0,c=void 0;i="answer"===o?t.answers:t.comments,c=i[n].liked?"unlike":"like";var u={pid:i[n]._id,uid:r._id,type:c,token:e.getToken()};s.changeStats(u).success(function(t){"like"===c?(i[n].likes+=1,i[n].liked=!0):(i[n].likes-=1,i[n].liked=!1)})},t.togglePostDislike=function(o,n){var i=void 0,c=void 0;i="answer"===o?t.answers:t.comments,c=i[n].disliked?"undo":"dislike";var u={pid:i[n]._id,uid:r._id,type:c,token:e.getToken()};s.changeStats(u).success(function(t){"dislike"===c?(i[n].dislikes+=1,i[n].disliked=!0):(i[n].dislikes-=1,i[n].disliked=!1)})},t.showComments=function(){var o={sortingMethod:"likes",pid:t.posts[index]._id,postType:"comment"};s.getSortedComments(o).success(function(o){console.log(o),r?(s.formatPosts(o,r),t.comments=o):t.comments=o})},t.deletePost=function(o,e){s.deletePost(o._id).success(function(o){switch(o.postType){case"comment":t.comments.splice(e,1);break;case"question":t.posts.splice(e,1)}}).error(function(t){console.log("failed at deletePost function "),console.error(t)})},t.submitComment=function(o,i){if(console.log(i),t.loggedIn){var c={content:o,author:r._id,responseTo:i._id,postType:"comment",token:e.getToken()};s.createPost(c).success(function(o){t.comments.push(o)}).error(function(t){console.log("error: ",t)})}else n.isNotLoggedIn()},t.loadMore=function(){for(var o=t.comments[t.comments.length-1],e=8,s=1;e>=s;s++)console.log("count is "+s),t.comments.push(o+"")},t.$emit("notHome"),t.$emit("getNotifications")}),app.controller("topicCtrl",function(t,o,e,s,n,i,r,c){var u=n.currentUser();t.loggedIn=n.isLoggedIn(),t.posts,t.topic,t.subscribed=!1,$(document).foundation(),function(){s.getTopic(e.topic).success(function(o){o.subscribers.forEach(function(o){o===u._id?t.subscribed=!0:t.subscribed=!1}),t.topic=o,r.formatPosts(o.posts,u),t.posts=o.posts}).error(function(t){console.log("error: ",t)})}(),t.subscribe=function(){var o={uid:u._id,topic:e.topic};console.log(o),i.subscribe(o).success(function(o){t.subscribed=!0}).error(function(t){console.log("error: ",t)})},t.unsubscribe=function(){var o={uid:u._id,topic:e.topic};i.unsubscribe(o).success(function(o){t.subscribed=!1}).error(function(t){console.log("error: ",t)})},t.togglePostLike=function(o){if(t.loggedIn){var e;e=t.posts[o].liked?"unlike":"like";var s={pid:t.posts[o]._id,uid:u._id,type:e,token:n.getToken()};r.changeStats(s).success(function(s){"like"===e?(t.posts[o].likes+=1,t.posts[o].liked=!0):(t.posts[o].likes-=1,t.posts[o].liked=!1)}).error(function(t){console.log("error: ",t)})}else c.isNotLoggedIn()},t.togglePostDislike=function(o){if(t.loggedIn){var e;e=t.posts[o].disliked?"undo":"dislike";var s={pid:t.posts[o]._id,uid:u._id,type:e,token:n.getToken()};r.changeStats(s).success(function(s){"dislike"===e?(t.posts[o].dislikes+=1,t.posts[o].disliked=!0):(t.posts[o].dislikes-=1,t.posts[o].disliked=!1)}).error(function(t){console.log("error: ",t)})}else c.isNotLoggedIn()},t.toggleCommentLike=function(o){if(t.loggedIn){var e;e=t.comments[o].liked?"unlike":"like";var s={pid:t.comments[o]._id,uid:u._id,type:e,token:n.getToken()};r.changeStats(s).success(function(s){"like"===e?(t.comments[o].likes+=1,t.comments[o].liked=!0):(t.comments[o].likes-=1,t.comments[o].liked=!1)}).error(function(t){console.log("error: ",t)})}else c.isNotLoggedIn()},t.toggleCommentDislike=function(o){if(t.loggedIn){var e;e=t.comments[o].disliked?"undo":"dislike";var s={pid:t.comments[o]._id,uid:u._id,type:e,token:n.getToken()};r.changeStats(s).success(function(s){"dislike"===e?(t.comments[o].dislikes+=1,t.comments[o].disliked=!0):(t.comments[o].dislikes-=1,t.comments[o].disliked=!1)}).error(function(t){console.log("error: ",t)})}else c.isNotLoggedIn()},t.showComments=function(o){t.posts[o].showComments=!0;var e=(t.posts[o].comments,{sortingMethod:"likes",pid:t.posts[o]._id,postType:"comment"});r.getSortedComments(e).success(function(o){r.formatPosts(o,u),console.log(o),t.comments=o})},t.hideComments=function(o){t.posts[o].showComments=!1},t.submitComment=function(o,e){if(t.loggedIn){var s={content:o,author:u._id,responseTo:e._id,postType:"comment",token:n.getToken()};r.createPost(s).success(function(o){t.comments.push(o),console.log(o)}).error(function(t){console.log("error: ",t)})}else c.isNotLoggedIn()},t.$emit("notHome"),t.$emit("getNotifications"),t.$on("loggedOut",function(){t.loggedIn=n.isLoggedIn()}),t.$on("loggedIn",function(){t.loggedIn=n.isLoggedIn()})}),app.controller("usersCtrl",function(t,o,e,s,n,i,r,c){t.Login=!1,t.tagFilter=!0,t.loggedIn=e.isLoggedIn(),t.currentUser=e.currentUser(),t.newNotifications=[],(t.switchState=function(){t.Login=!t.Login,t.Login?t.currentState="Create Account":t.currentState="Go to Login",t.Login?t.formState="Login":t.formState="Register"})(),t.login=function(s,n){var i={username:s,password:n};e.login(i).success(function(e){t.$emit("login"),o.go("home")}).error(function(t){swal({title:"Input Not Valid??",text:"Either the username or password was entered incorrectly",timer:2e3,type:"error",confirmButtonColor:"#B92B27"})})},t.register=function(s){s.upload=r.upload({url:"auth/register",data:{file:s,username:t.username,email:t.email,fullName:t.fullName,password:t.password}}),s.upload.then(function(n){e.saveToken(n.data.token),t.$emit("login"),c(function(){s.result=n.data,o.go("home")})},function(o){o.status>0&&(t.errorMsg=o.status+": "+o.data)},function(t){s.progress=Math.min(100,parseInt(100*t.loaded/t.total))})},t.logout=function(){e.logout(),t.$emit("logout"),o.go("users.login")},t.filterByTag=function(o){n.getPostsByTag(o).success(function(o){t.$emit("tag posts",o)}).error(function(t){console.log("error: ",t)})},t.$on("removeTagFilter",function(){t.tagFilter=!1}),t.$on("addTagFilter",function(){t.tagFilter=!0}),t.$on("notifications",function(){s.getUser(t.currentUser._id).success(function(o){t.picture=e.loggedInUser.picture,t.newNotifications=o.notifications.filter(function(t){return!t.seen})}).error(function(t){console.log("error: ",t)})}),t.$on("loggedOut",function(){t.loggedIn=e.isLoggedIn(),t.notifications=[]}),t.$on("loggedIn",function(){t.loggedIn=e.isLoggedIn(),t.currentUser=e.currentUser(),s.getUser(t.currentUser._id).success(function(o){t.picture=e.loggedInUser.picture,t.newNotifications=o.notifications.filter(function(t){return!t.seen})}).error(function(t){console.log("error: ",t)})})}),app.directive("ngEnter",function(){return function(t,o,e){o.bind("keydown keypress",function(o){13===o.which&&(t.$apply(function(){t.$eval(e.ngEnter)}),o.preventDefault())})}}),app.factory("auth",function(t,o,e){var s={};return s.loggedInUser,s.saveToken=function(o){t.localStorage[e]=o},s.getToken=function(){return t.localStorage[e]},s.isLoggedIn=function(){var o=s.getToken();if(o){var e=JSON.parse(t.atob(o.split(".")[1]));return e.exp>Date.now()/1e3}return!1},s.currentUser=function(){if(s.isLoggedIn()){var e=s.getToken(),n=JSON.parse(t.atob(e.split(".")[1]));return o.get("/users/"+n._id).then(function(t){s.loggedInUser=t.data})["catch"](function(t){console.log("err",t)}),n}},s.register=function(t){return o.post("/auth/register",t).success(function(t){s.saveToken(t.token)})},s.login=function(t){return o.post("/auth/login",t).success(function(t){s.saveToken(t.token)})},s.logout=function(){t.localStorage.removeItem(e)},s}),app.factory("postFactory",function(t,o,e){var s={};return s.createPost=function(t){return o.post("/posts/add",t).success(function(t){return s.isUserPost(t,e.currentUser()),t})},s.deletePost=function(t){return o["delete"]("/posts/delete/"+t)},s.changeStats=function(t){return o.put("/posts/changeStats",t)},s.getPost=function(t){return o.get("/posts/"+t)},s.editPost=function(t){return o.put("/posts/edit",t)},s.getPostsByTag=function(t){return o.get("/posts/sorted/user/topic/tag/"+t+"/postType/").success(function(t){return s.formatPosts(t,e.currentUser()),t})},s.getPostsByTopic=function(t){return o.get("/posts/sorted/user/topic/"+t+"/tag/postType/").success(function(t){return s.formatPosts(t,e.currentUser()),t})},s.getSortedPosts=function(t){return o.get("/posts/sorted/"+t.sortingMethod+"/user/topic/tag/postType/"+t.postType).success(function(t){return s.formatPosts(t,e.currentUser()),t})},s.subscriptionsPosts=function(t){return o.get("/posts/sorted/user/"+t+"/topic/tag/postType/").success(function(t){return s.formatPosts(t,e.currentUser()),t})},s.getSortedComments=function(t){return o.get("/posts/sortedReplies/postType/"+t.postType+"/sortingMethod/"+t.sortingMethod+"/post/"+t.pid).success(function(t){return console.log(t),s.formatPosts(t,e.currentUser()),t})},s.getSortedAnswers=function(t){return o.get("/posts/sortedReplies/"+t.postType+"/sortingMethod/"+t.sortingMethod+"/post/"+t.pid).success(function(t){return s.formatPosts(t,e.currentUser()),t})},s.formatLikedPosts=function(t,o){t.map(function(t){return t.likers.forEach(function(e){if(e.toString()===o._id.toString()){var s=t;return s.liked=!0,s}return t})}),t.map(function(t){return t.dislikers.forEach(function(e){if(e.toString()===o._id.toString()){var s=t;return s.disliked=!0,s}return t})})},s.formatTags=function(t){t.map(function(t){var o="";return t.tags.forEach(function(t){o+=t+", "}),t.tags=o,t})},s.isUserPost=function(t,o){t.author._id.toString()===o._id.toString()?t.userPost=!0:t.userPost=!1},s.formatUserPosts=function(t,o){t.map(function(t){t.author._id.toString()===o._id.toString()?t.userPost=!0:t.userPost=!1})},s.answerWritten=function(t){t.map(function(t){t.answers.length>0?t.answerWritten=!0:t.answerWritten=!1})},s.formatPosts=function(t,o){return s.formatLikedPosts(t,o),s.formatUserPosts(t,o),s.formatTags(t),s.answerWritten(t),t},s}),app.factory("topicFactory",function(t,o){var e={};return e.getTopics=function(){return o.get("/topics/allTopics")},e.subscribedTopics=function(){return o.get("/topics/allTopics")},e.get7Topics=function(){return o.get("/topics/limit7")},e.getTopic=function(t){return o.get("/topics/topic/"+t)},e.createTopic=function(t){return o.post("/topics/add",t)},e.deleteTopic=function(t){return o["delete"]("/topics/delete",t)},e}),app.factory("userFactory",function(t,o,e,s){var n={};return n.getUser=function(t){return o.get("/users/"+t).success(function(t){return e.formatPosts(t.posts,s.currentUser()),t})},n.getNotifs=function(t){return o.get("/users/notifications/"+t.uid)},n.clearNotifs=function(t){return o.post("/users/clearNotifications",t)},n.addKnowledge=function(t){return o.post("/users/addKnowledge",t)},n.updateInfo=function(t){var e=new Object;for(var n in t)0!==t[n].length&&(e[n]=t[n]);return e.uid=s.currentUser()._id,o.put("/users/updateInfo",e)},n.follow=function(t){return o.post("/users/follow",t)},n.unfollow=function(t){return o.put("/users/unfollow",t)},n.subscribe=function(t){return o.post("/users/subscribe",t)},n.unsubscribe=function(t){return o.put("/users/unsubscribe",t)},n});